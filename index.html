<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Demande de diagnostic — POC</title>
  <style>
    :root{ --bg:#0b1222; --panel:#101b34; --text:#e8f0ff; --muted:#a8b3cc; --accent:#4f7cff; --ok:#16a34a; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:24px; border-bottom:1px solid #1e2a4a; }
    h1{ margin:0; font-size:20px; font-weight:700; letter-spacing:.2px; }
    main{ max-width:920px; margin:0 auto; padding:24px; }
    .card{ background:var(--panel); border:1px solid #1a2747; border-radius:16px; padding:20px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
    label{ display:block; font-weight:600; margin-bottom:8px; }
    textarea{ width:100%; min-height:140px; padding:12px; border-radius:12px; border:1px solid #243459; background:#0d1730; color:var(--text); resize:vertical; }
    select,button{ height:42px; border-radius:12px; border:1px solid #243459; background:#0d1730; color:var(--text); padding:0 12px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    .row > * { flex:1 1 240px; }
    button.primary{ background:var(--accent); border-color:var(--accent); color:white; font-weight:700; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .muted{ color:var(--muted); font-size:14px; }
    .error{ color:#f97316; font-size:14px; font-weight:600; }
    .result{ margin-top:20px; display:none; }
    .result h2{ margin:0 0 8px 0; font-size:18px; }
    .result section{ background:#0d1730; border:1px solid #223760; padding:14px; border-radius:12px; margin-top:12px; }
    .badge{ display:inline-block; padding:4px 10px; border-radius:999px; background:#112352; border:1px solid #26407a; font-size:12px; color:#b8c8ee; }
    .badge-group{ display:flex; gap:8px; flex-wrap:wrap; margin:0 0 12px; }
    .diagnostic{ margin-top:20px; background:#0d1730; border:1px solid #223760; border-radius:12px; padding:16px; display:none; }
    .question-list{ display:flex; flex-direction:column; gap:16px; margin-top:16px; }
    .question-card{ border:1px solid #2b4376; border-radius:12px; padding:12px 14px; background:#0f1d36; }
    .question-card label{ font-weight:600; margin-bottom:6px; }
    .question-card textarea{ min-height:80px; }
    .question-card .hint{ display:block; margin-top:4px; font-size:13px; color:var(--muted); }
    .question-options{ display:flex; flex-direction:column; gap:6px; margin-top:10px; }
    .question-options label{ display:flex; align-items:center; gap:8px; font-weight:500; }
    .question-options input{ width:18px; height:18px; }
    .diagnostic-summary{ margin-top:20px; }
    footer{ max-width:920px; margin:24px auto; padding:0 24px 24px; color:#9cb0d8; font-size:13px; }
    .ok{ color:var(--ok); font-weight:600; }
    .spinner{ display:inline-block; width:16px; height:16px; border:2px solid #9fb4ff; border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite; vertical-align:-3px; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
  </style>
</head>
<body>
  <header>
    <h1>Demande de diagnostic — POC plateforme IA</h1>
  </header>
  <main>
    <div class="card">
      <label for="need">Décrivez en quelques lignes votre besoin</label>
      <textarea id="need" placeholder="Ex : Nous voulons évaluer la maturité de notre organisation achats : canaux d’achat, catalogues, gouvernance, outils, etc. Contexte : plusieurs entités, hétérogénéité des pratiques, besoin de gains court terme..."></textarea>

      <div class="row">
        <div>
          <label for="theme">Thème (optionnel)</label>
          <select id="theme">
            <option value="">Auto-détection</option>
            <option>Organisation achats</option>
            <option>Maturité digitale / IA</option>
            <option>Gouvernance & Data</option>
            <option>Études de marché</option>
            <option>PMO & exécution</option>
          </select>
        </div>
        <div>
          <label for="tone">Format de sortie</label>
          <select id="tone">
            <option value="consulting">Consulting (clair et structuré)</option>
            <option value="executive">Exécutif (ultra synthèse)</option>
            <option value="detailed">Détaillé (plus d’éléments)</option>
          </select>
        </div>
        <div>
          <label for="model">Modèle IA</label>
          <select id="model">
            <option value="simple">Gemini 1.5 Flash (rapide)</option>
            <option value="balanced" selected>Gemini 2.0 Flash (équilibré)</option>
            <option value="pro">Gemini 1.5 Pro (avancé)</option>
            <option value="max">Gemini 2.5 Pro (maximum)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <button id="runBtn" class="primary">Générer ma proposition</button>
        <span id="status" class="muted"></span>
      </div>

      <div id="result" class="result">
        <div class="badge-group">
          <span class="badge" id="detected"></span>
          <span class="badge" id="modelUsed"></span>
        </div>
        <section>
          <h2>Approche proposée</h2>
          <div id="approach"></div>
        </section>
        <section>
          <h2>Prochaines étapes</h2>
          <div id="next"></div>
        </section>
        <div class="row" style="margin-top:12px;">
          <button id="startMini" class="primary">Lancer un mini-diagnostic (10 questions)</button>
          <button id="downloadPdf">Télécharger en PDF</button>
        </div>
        <div id="diagnostic" class="diagnostic">
          <p class="muted">Répondez au questionnaire ciblé (10 questions) pour affiner la compréhension de votre contexte interne.</p>
          <div id="diagnosticStatus" class="muted"></div>
          <form id="diagnosticForm" style="display:none;">
            <div id="diagnosticQuestions" class="question-list"></div>
            <div class="row" style="margin-top:16px;">
              <button type="submit" class="primary" id="submitDiagnostic">Analyser mes réponses</button>
            </div>
          </form>
          <section id="diagnosticSummary" class="diagnostic-summary" style="display:none;">
            <h2>Synthèse du diagnostic</h2>
            <div id="diagnosticSummaryBody"></div>
          </section>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <div>POC — aucune donnée sensible, sortie indicative. Hébergé statiquement (GitHub Pages) + API proxy LLM côté serveur.</div>
  </footer>

  <script>
    const API_BASE = (() => {
      if (window.API_BASE_OVERRIDE && typeof window.API_BASE_OVERRIDE === "string") {
        return window.API_BASE_OVERRIDE.replace(/\/$/, "");
      }
      const origin = window.location.origin;
      const hostname = window.location.hostname;
      const isLocalhost = hostname === "localhost" || hostname.startsWith("127.") || hostname.endsWith(".local");

      if (origin && origin !== "null" && !isLocalhost) {
        if (/github\.io$/i.test(hostname)) {
          return "https://poc-consulting.netlify.app/.netlify/functions";
        }
        return `${origin.replace(/\/$/, "")}/.netlify/functions`;
      }

      if (isLocalhost && origin && origin !== "null") {
        return `${origin.replace(/\/$/, "")}/.netlify/functions`;
      }

      return "https://poc-consulting.netlify.app/.netlify/functions";
    })();
    const runBtn = document.getElementById("runBtn");
    const needEl = document.getElementById("need");
    const themeEl = document.getElementById("theme");
    const toneEl = document.getElementById("tone");
    const modelEl = document.getElementById("model");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const approachEl = document.getElementById("approach");
    const nextEl = document.getElementById("next");
    const detectedEl = document.getElementById("detected");
    const modelUsedEl = document.getElementById("modelUsed");
    const startMiniBtn = document.getElementById("startMini");
    const diagnosticContainer = document.getElementById("diagnostic");
    const diagnosticStatusEl = document.getElementById("diagnosticStatus");
    const diagnosticForm = document.getElementById("diagnosticForm");
    const diagnosticQuestionsEl = document.getElementById("diagnosticQuestions");
    const diagnosticSummaryEl = document.getElementById("diagnosticSummary");
    const diagnosticSummaryBodyEl = document.getElementById("diagnosticSummaryBody");
    const submitDiagnosticBtn = document.getElementById("submitDiagnostic");
    modelUsedEl.style.display = "none";

    let currentQuestions = [];
    let questionElements = new Map();

    const resetDiagnosticView = () => {
      diagnosticStatusEl.textContent = "";
      diagnosticQuestionsEl.innerHTML = "";
      diagnosticForm.style.display = "none";
      diagnosticSummaryEl.style.display = "none";
      diagnosticSummaryBodyEl.innerHTML = "";
      diagnosticContainer.style.display = "none";
      currentQuestions = [];
      questionElements = new Map();
      startMiniBtn.textContent = "Lancer un mini-diagnostic (10 questions)";
    };

    resetDiagnosticView();

    const renderDiagnosticQuestions = (questions) => {
      diagnosticQuestionsEl.innerHTML = "";
      questionElements = new Map();
      questions.forEach((question, index) => {
        const card = document.createElement("div");
        card.className = "question-card";
        card.dataset.questionId = question.id;
        card.dataset.type = question.type;

        const title = document.createElement("label");
        const safeId = `diag-q${index + 1}`;
        title.setAttribute("for", safeId);
        title.textContent = `${index + 1}. ${question.label}`;
        card.appendChild(title);

        if (question.type === "checkbox" && Array.isArray(question.options) && question.options.length) {
          const optionsWrapper = document.createElement("div");
          optionsWrapper.className = "question-options";
          question.options.forEach((opt, optIndex) => {
            const optionId = `${safeId}-opt${optIndex + 1}`;
            const optionLabel = document.createElement("label");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = opt;
            checkbox.id = optionId;
            checkbox.name = safeId;
            optionLabel.appendChild(checkbox);
            const text = document.createElement("span");
            text.textContent = opt;
            optionLabel.appendChild(text);
            optionsWrapper.appendChild(optionLabel);
          });
          card.appendChild(optionsWrapper);
          if (question.placeholder) {
            const hint = document.createElement("span");
            hint.className = "hint";
            hint.textContent = question.placeholder;
            card.appendChild(hint);
          }
        } else {
          const textarea = document.createElement("textarea");
          textarea.id = safeId;
          textarea.placeholder = question.placeholder || "";
          card.appendChild(textarea);
        }

        diagnosticQuestionsEl.appendChild(card);
        questionElements.set(question.id, card);
      });
    };

    const friendlyError = (code, details = {}) => Object.assign(new Error(code), { code, ...details });

    const formatErrorMessage = (err) => {
      if (err?.code === "API_BASE_NOT_CONFIGURED") {
        return "API non configurée : remplace l'URL factice dans le code par celle de ton déploiement (ex. domaine Netlify).";
      }
      if (err?.code === "HTTP_ERROR") {
        const base = `Le serveur a répondu ${err.status ?? "avec une erreur"}.`;
        const body = err.body ? ` Détails : ${err.body.slice(0, 200)}${err.body.length > 200 ? "…" : ""}` : "";
        return `${base}${body}`;
      }
      if (err?.code === "BAD_JSON") {
        return "La réponse reçue n'est pas un JSON valide. Vérifie que l'API renvoie bien du JSON.";
      }
      if (err?.code === "NETWORK_ERROR") {
        return "Impossible de contacter l'API. Vérifie l'URL, la connexion réseau ou les autorisations CORS.";
      }
      if (err?.code === "NO_QUESTIONS") {
        return "Le modèle n'a pas fourni de questionnaire exploitable. Merci de réessayer.";
      }
      return err?.message || "Une erreur inattendue est survenue.";
    };

    const ensureApiConfigured = () => {
      if (!API_BASE || API_BASE.includes("YOUR-NETLIFY")) {
        throw friendlyError("API_BASE_NOT_CONFIGURED");
      }
    };

    runBtn.addEventListener("click", async () => {
      const need = needEl.value.trim();
      if (!need) { alert("Merci de décrire le besoin."); return; }

      resetDiagnosticView();
      runBtn.disabled = true;
      statusEl.innerHTML = '<span class="spinner"></span> Analyse en cours…';

      try {
        ensureApiConfigured();
        const res = await fetch(`${API_BASE}/analyze-need`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            need,
            theme: themeEl.value,
            tone: toneEl.value,
            modelKey: modelEl.value
          })
        });
        if (!res.ok) {
          const body = await res.text().catch(() => "");
          throw friendlyError("HTTP_ERROR", { status: `${res.status} ${res.statusText}`.trim(), body });
        }
        let data;
        try {
          data = await res.json();
        } catch (parseErr) {
          throw friendlyError("BAD_JSON");
        }

        detectedEl.textContent = data.detectedTheme ? `Cadre: ${data.detectedTheme}` : "Cadre: (auto)";
        modelUsedEl.textContent = data.modelUsed ? `Modèle: ${data.modelUsed}` : "";
        modelUsedEl.style.display = data.modelUsed ? "inline-block" : "none";
        approachEl.innerHTML = data.approachHtml || `<pre>${data.approach}</pre>`;
        nextEl.innerHTML = data.nextStepsHtml || `<pre>${data.nextSteps}</pre>`;

        resultEl.style.display = "block";
        statusEl.innerHTML = '<span class="ok">Proposition générée.</span>';
      } catch (e) {
        console.error(e);
        const err = e instanceof Error ? e : new Error(String(e));
        if (!err.code && err.name === "TypeError") {
          err.code = "NETWORK_ERROR";
        }
        resultEl.style.display = "none";
        modelUsedEl.textContent = "";
        modelUsedEl.style.display = "none";
        statusEl.innerHTML = `<span class="error">${formatErrorMessage(err)}</span>`;
      } finally {
        runBtn.disabled = false;
      }
    });

    startMiniBtn.addEventListener("click", async () => {
      if (resultEl.style.display !== "block") { alert("Générez d'abord une proposition avant de lancer le mini-diagnostic."); return; }
      const need = needEl.value.trim();
      if (!need) { alert("Merci de décrire le besoin avant de lancer le diagnostic."); return; }

      diagnosticContainer.style.display = "block";
      diagnosticForm.style.display = "none";
      diagnosticSummaryEl.style.display = "none";
      diagnosticSummaryBodyEl.innerHTML = "";
      diagnosticStatusEl.innerHTML = '<span class="spinner"></span> Génération du questionnaire…';
      startMiniBtn.disabled = true;

      try {
        ensureApiConfigured();
        const res = await fetch(`${API_BASE}/diagnostic`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "generate",
            need,
            theme: themeEl.value,
            tone: toneEl.value,
            modelKey: modelEl.value
          })
        });
        if (!res.ok) {
          const body = await res.text().catch(() => "");
          throw friendlyError("HTTP_ERROR", { status: `${res.status} ${res.statusText}`.trim(), body });
        }
        let data;
        try {
          data = await res.json();
        } catch (parseErr) {
          throw friendlyError("BAD_JSON");
        }

        if (data.modelUsed) {
          modelUsedEl.textContent = `Modèle: ${data.modelUsed}`;
          modelUsedEl.style.display = "inline-block";
        }
        currentQuestions = Array.isArray(data.questions) ? data.questions : [];
        if (!currentQuestions.length) {
          throw friendlyError("NO_QUESTIONS");
        }

        renderDiagnosticQuestions(currentQuestions);
        diagnosticForm.style.display = "block";
        diagnosticStatusEl.innerHTML = '<span class="ok">Questionnaire généré. Répondez aux 10 questions ci-dessous.</span>';
        diagnosticSummaryEl.style.display = "none";
        diagnosticSummaryBodyEl.innerHTML = "";
        startMiniBtn.textContent = "Régénérer le mini-diagnostic";
        diagnosticContainer.scrollIntoView({ behavior: "smooth", block: "start" });
      } catch (e) {
        console.error(e);
        const err = e instanceof Error ? e : new Error(String(e));
        if (!err.code && err.name === "TypeError") {
          err.code = "NETWORK_ERROR";
        }
        diagnosticForm.style.display = "none";
        diagnosticStatusEl.innerHTML = `<span class="error">${formatErrorMessage(err)}</span>`;
      } finally {
        startMiniBtn.disabled = false;
      }
    });

    diagnosticForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!currentQuestions.length) { alert("Générez d'abord le questionnaire."); return; }
      const need = needEl.value.trim();
      if (!need) { alert("Merci de décrire le besoin avant d'analyser vos réponses."); return; }

      submitDiagnosticBtn.disabled = true;
      diagnosticStatusEl.innerHTML = '<span class="spinner"></span> Analyse des réponses…';

      try {
        ensureApiConfigured();
        const answers = currentQuestions.map((question) => {
          const card = questionElements.get(question.id);
          if (!card) {
            return { id: question.id, value: question.type === "checkbox" ? [] : "" };
          }
          if (question.type === "checkbox") {
            const selected = Array.from(card.querySelectorAll('input[type="checkbox"]:checked')).map((input) => input.value);
            return { id: question.id, value: selected };
          }
          const textarea = card.querySelector("textarea");
          return { id: question.id, value: textarea ? textarea.value.trim() : "" };
        });

        const res = await fetch(`${API_BASE}/diagnostic`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "analyze",
            need,
            theme: themeEl.value,
            tone: toneEl.value,
            modelKey: modelEl.value,
            answers,
            questions: currentQuestions
          })
        });
        if (!res.ok) {
          const body = await res.text().catch(() => "");
          throw friendlyError("HTTP_ERROR", { status: `${res.status} ${res.statusText}`.trim(), body });
        }
        let data;
        try {
          data = await res.json();
        } catch (parseErr) {
          throw friendlyError("BAD_JSON");
        }

        if (data.modelUsed) {
          modelUsedEl.textContent = `Modèle: ${data.modelUsed}`;
          modelUsedEl.style.display = "inline-block";
        }
        diagnosticSummaryBodyEl.innerHTML = data.summaryHtml || `<pre>${data.summary}</pre>`;
        diagnosticSummaryEl.style.display = "block";
        diagnosticStatusEl.innerHTML = '<span class="ok">Synthèse générée.</span>';
        diagnosticContainer.scrollIntoView({ behavior: "smooth", block: "start" });
      } catch (e) {
        console.error(e);
        const err = e instanceof Error ? e : new Error(String(e));
        if (!err.code && err.name === "TypeError") {
          err.code = "NETWORK_ERROR";
        }
        diagnosticStatusEl.innerHTML = `<span class="error">${formatErrorMessage(err)}</span>`;
      } finally {
        submitDiagnosticBtn.disabled = false;
      }
    });

    document.getElementById("downloadPdf").addEventListener("click", () => {
      // Version simple : invite l’utilisateur à imprimer en PDF (Ctrl/Cmd+P)
      window.print();
    });
  </script>
</body>
</html>

