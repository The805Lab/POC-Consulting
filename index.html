<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Demande de diagnostic — POC</title>
  <style>
    :root{ --bg:#0b1222; --panel:#101b34; --text:#e8f0ff; --muted:#a8b3cc; --accent:#4f7cff; --ok:#16a34a; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:24px; border-bottom:1px solid #1e2a4a; }
    h1{ margin:0; font-size:20px; font-weight:700; letter-spacing:.2px; }
    main{ max-width:920px; margin:0 auto; padding:24px; }
    .card{ background:var(--panel); border:1px solid #1a2747; border-radius:16px; padding:20px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
    label{ display:block; font-weight:600; margin-bottom:8px; }
    textarea{ width:100%; min-height:140px; padding:12px; border-radius:12px; border:1px solid #243459; background:#0d1730; color:var(--text); resize:vertical; }
    select,button{ height:42px; border-radius:12px; border:1px solid #243459; background:#0d1730; color:var(--text); padding:0 12px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    .row > * { flex:1 1 240px; }
    button.primary{ background:var(--accent); border-color:var(--accent); color:white; font-weight:700; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .muted{ color:var(--muted); font-size:14px; }
    .error{ color:#f97316; font-size:14px; font-weight:600; }
    .result{ margin-top:20px; display:none; }
    .result h2{ margin:0 0 8px 0; font-size:18px; }
    .result section{ background:#0d1730; border:1px solid #223760; padding:14px; border-radius:12px; margin-top:12px; }
    .badge{ display:inline-block; padding:4px 10px; border-radius:999px; background:#112352; border:1px solid #26407a; font-size:12px; color:#b8c8ee; }
    .badge-group{ display:flex; gap:8px; flex-wrap:wrap; margin:0 0 12px; }
    footer{ max-width:920px; margin:24px auto; padding:0 24px 24px; color:#9cb0d8; font-size:13px; }
    .ok{ color:var(--ok); font-weight:600; }
    .spinner{ display:inline-block; width:16px; height:16px; border:2px solid #9fb4ff; border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite; vertical-align:-3px; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
  </style>
</head>
<body>
  <header>
    <h1>Demande de diagnostic — POC plateforme IA</h1>
  </header>
  <main>
    <div class="card">
      <label for="need">Décrivez en quelques lignes votre besoin</label>
      <textarea id="need" placeholder="Ex : Nous voulons évaluer la maturité de notre organisation achats : canaux d’achat, catalogues, gouvernance, outils, etc. Contexte : plusieurs entités, hétérogénéité des pratiques, besoin de gains court terme..."></textarea>

      <div class="row">
        <div>
          <label for="theme">Thème (optionnel)</label>
          <select id="theme">
            <option value="">Auto-détection</option>
            <option>Organisation achats</option>
            <option>Maturité digitale / IA</option>
            <option>Gouvernance & Data</option>
            <option>Études de marché</option>
            <option>PMO & exécution</option>
          </select>
        </div>
        <div>
          <label for="tone">Format de sortie</label>
          <select id="tone">
            <option value="consulting">Consulting (clair et structuré)</option>
            <option value="executive">Exécutif (ultra synthèse)</option>
            <option value="detailed">Détaillé (plus d’éléments)</option>
          </select>
        </div>
        <div>
          <label for="model">Modèle IA</label>
          <select id="model">
            <option value="simple">Gemini 1.5 Flash (rapide)</option>
            <option value="balanced" selected>Gemini 2.0 Flash (équilibré)</option>
            <option value="pro">Gemini 1.5 Pro (avancé)</option>
            <option value="max">Gemini 2.5 Pro (maximum)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <button id="runBtn" class="primary">Générer ma proposition</button>
        <span id="status" class="muted"></span>
      </div>

      <div id="result" class="result">
        <div class="badge-group">
          <span class="badge" id="detected"></span>
          <span class="badge" id="modelUsed"></span>
        </div>
        <section>
          <h2>Approche proposée</h2>
          <div id="approach"></div>
        </section>
        <section>
          <h2>Prochaines étapes</h2>
          <div id="next"></div>
        </section>
        <div class="row" style="margin-top:12px;">
          <button id="startMini" class="primary">Lancer un mini-diagnostic (5–6 questions)</button>
          <button id="downloadPdf">Télécharger en PDF</button>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <div>POC — aucune donnée sensible, sortie indicative. Hébergé statiquement (GitHub Pages) + API proxy LLM côté serveur.</div>
  </footer>

  <script>
    const API_BASE = "https://poc-consulting.netlify.app/.netlify/functions"; // ← remplace par ton URL
    const runBtn = document.getElementById("runBtn");
    const needEl = document.getElementById("need");
    const themeEl = document.getElementById("theme");
    const toneEl = document.getElementById("tone");
    const modelEl = document.getElementById("model");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const approachEl = document.getElementById("approach");
    const nextEl = document.getElementById("next");
    const detectedEl = document.getElementById("detected");
    const modelUsedEl = document.getElementById("modelUsed");
    modelUsedEl.style.display = "none";

    const friendlyError = (code, details = {}) => Object.assign(new Error(code), { code, ...details });

    const formatErrorMessage = (err) => {
      if (err?.code === "API_BASE_NOT_CONFIGURED") {
        return "API non configurée : remplace l'URL factice dans le code par celle de ton déploiement (ex. domaine Netlify).";
      }
      if (err?.code === "HTTP_ERROR") {
        const base = `Le serveur a répondu ${err.status ?? "avec une erreur"}.`;
        const body = err.body ? ` Détails : ${err.body.slice(0, 200)}${err.body.length > 200 ? "…" : ""}` : "";
        return `${base}${body}`;
      }
      if (err?.code === "BAD_JSON") {
        return "La réponse reçue n'est pas un JSON valide. Vérifie que l'API renvoie bien du JSON.";
      }
      if (err?.code === "NETWORK_ERROR") {
        return "Impossible de contacter l'API. Vérifie l'URL, la connexion réseau ou les autorisations CORS.";
      }
      return err?.message || "Une erreur inattendue est survenue.";
    };

    const ensureApiConfigured = () => {
      if (!API_BASE || API_BASE.includes("YOUR-NETLIFY")) {
        throw friendlyError("API_BASE_NOT_CONFIGURED");
      }
    };

    runBtn.addEventListener("click", async () => {
      const need = needEl.value.trim();
      if (!need) { alert("Merci de décrire le besoin."); return; }

      runBtn.disabled = true;
      statusEl.innerHTML = '<span class="spinner"></span> Analyse en cours…';

      try {
        ensureApiConfigured();
        const res = await fetch(`${API_BASE}/analyze-need`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            need,
            theme: themeEl.value,
            tone: toneEl.value,
            modelKey: modelEl.value
          })
        });
        if (!res.ok) {
          const body = await res.text().catch(() => "");
          throw friendlyError("HTTP_ERROR", { status: `${res.status} ${res.statusText}`.trim(), body });
        }
        let data;
        try {
          data = await res.json();
        } catch (parseErr) {
          throw friendlyError("BAD_JSON");
        }

        detectedEl.textContent = data.detectedTheme ? `Cadre: ${data.detectedTheme}` : "Cadre: (auto)";
        modelUsedEl.textContent = data.modelUsed ? `Modèle: ${data.modelUsed}` : "";
        modelUsedEl.style.display = data.modelUsed ? "inline-block" : "none";
        approachEl.innerHTML = data.approachHtml || `<pre>${data.approach}</pre>`;
        nextEl.innerHTML = data.nextStepsHtml || `<pre>${data.nextSteps}</pre>`;

        resultEl.style.display = "block";
        statusEl.innerHTML = '<span class="ok">Proposition générée.</span>';
      } catch (e) {
        console.error(e);
        const err = e instanceof Error ? e : new Error(String(e));
        if (!err.code && err.name === "TypeError") {
          err.code = "NETWORK_ERROR";
        }
        resultEl.style.display = "none";
        modelUsedEl.textContent = "";
        modelUsedEl.style.display = "none";
        statusEl.innerHTML = `<span class="error">${formatErrorMessage(err)}</span>`;
      } finally {
        runBtn.disabled = false;
      }
    });

    document.getElementById("startMini").addEventListener("click", () => {
      alert("Mini-diagnostic à venir (5–6 questions). POC : bouton factice pour l’instant.");
    });

    document.getElementById("downloadPdf").addEventListener("click", () => {
      // Version simple : invite l’utilisateur à imprimer en PDF (Ctrl/Cmd+P)
      window.print();
    });
  </script>
</body>
</html>

