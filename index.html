<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Demande de diagnostic — POC</title>
  <style>
    :root{ --bg:#0b1222; --panel:#101b34; --text:#e8f0ff; --muted:#a8b3cc; --accent:#4f7cff; --ok:#16a34a; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:24px; border-bottom:1px solid #1e2a4a; }
    h1{ margin:0; font-size:20px; font-weight:700; letter-spacing:.2px; }
    main{ max-width:920px; margin:0 auto; padding:24px; }
    .card{ background:var(--panel); border:1px solid #1a2747; border-radius:16px; padding:20px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
    label{ display:block; font-weight:600; margin-bottom:8px; }
    textarea{ width:100%; min-height:140px; padding:12px; border-radius:12px; border:1px solid #243459; background:#0d1730; color:var(--text); resize:vertical; }
    select,button{ height:42px; border-radius:12px; border:1px solid #243459; background:#0d1730; color:var(--text); padding:0 12px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    .row > * { flex:1 1 240px; }
    button.primary{ background:var(--accent); border-color:var(--accent); color:white; font-weight:700; cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .muted{ color:var(--muted); font-size:14px; }
    .error{ color:#f97316; font-size:14px; font-weight:600; }
    .result{ margin-top:20px; display:none; }
    .result h2{ margin:0 0 8px 0; font-size:18px; }
    .result section{ background:#0d1730; border:1px solid #223760; padding:14px; border-radius:12px; margin-top:12px; }
    .badge{ display:inline-block; padding:4px 10px; border-radius:999px; background:#112352; border:1px solid #26407a; font-size:12px; color:#b8c8ee; }
    .badge-group{ display:flex; gap:8px; flex-wrap:wrap; margin:0 0 12px; }
    footer{ max-width:920px; margin:24px auto; padding:0 24px 24px; color:#9cb0d8; font-size:13px; }
    .ok{ color:var(--ok); font-weight:600; }
    .spinner{ display:inline-block; width:16px; height:16px; border:2px solid #9fb4ff; border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite; vertical-align:-3px; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
    .hidden{ display:none !important; }
    button.secondary{ background:transparent; border-color:#2a3a66; color:var(--muted); }
    button.secondary:hover{ border-color:var(--accent); color:var(--text); }
    .diagnostic{ margin-top:24px; background:#0d1730; border:1px solid #223760; border-radius:16px; padding:18px 20px; }
    .diagnostic h3{ margin:0 0 4px 0; font-size:17px; }
    .diagnostic .muted{ margin-top:4px; }
    .diagnostic-expectations{ margin:12px 0 0; padding-left:18px; line-height:1.5; }
    .diagnostic-expectations.hidden{ display:none; }
    .diagnostic-form fieldset{ border:1px solid #1f2f55; border-radius:14px; padding:12px 16px; margin:16px 0 0; }
    .diagnostic-form legend{ font-weight:600; padding:0 6px; }
    .diagnostic-form .question-description{ margin:6px 0 0; color:var(--muted); font-size:14px; }
    .diagnostic-form .question-options{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .diagnostic-form .option-pill{ display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid #223760; border-radius:10px; background:#0b1730; cursor:pointer; transition:border-color .2s, background .2s; }
    .diagnostic-form .option-pill:hover{ border-color:var(--accent); background:#101c3a; }
    .diagnostic-form .option-pill input{ accent-color:var(--accent); }
    .diagnostic-form textarea{ min-height:80px; margin-top:10px; }
    .diagnostic-actions{ margin-top:18px; }
    .diagnostic-summary{ margin-top:18px; background:#081123; border:1px solid #1a2747; border-radius:14px; padding:16px; }
    .diagnostic-summary.hidden{ display:none; }
    .diagnostic-summary h3, .diagnostic-summary h4{ margin-top:0; }
    .diagnostic-summary ul{ padding-left:18px; margin:10px 0; }
    .diagnostic-summary p{ margin:10px 0; }
  </style>
</head>
<body>
  <header>
    <h1>Demande de diagnostic — POC plateforme IA</h1>
  </header>
  <main>
    <div class="card">
      <label for="need">Décrivez en quelques lignes votre besoin</label>
      <textarea id="need" placeholder="Ex : Nous voulons évaluer la maturité de notre organisation achats : canaux d’achat, catalogues, gouvernance, outils, etc. Contexte : plusieurs entités, hétérogénéité des pratiques, besoin de gains court terme..."></textarea>

      <div class="row">
        <div>
          <label for="theme">Thème (optionnel)</label>
          <select id="theme">
            <option value="">Auto-détection</option>
            <option>Organisation achats</option>
            <option>Maturité digitale / IA</option>
            <option>Gouvernance & Data</option>
            <option>Études de marché</option>
            <option>PMO & exécution</option>
          </select>
        </div>
        <div>
          <label for="tone">Format de sortie</label>
          <select id="tone">
            <option value="consulting">Consulting (clair et structuré)</option>
            <option value="executive">Exécutif (ultra synthèse)</option>
            <option value="detailed">Détaillé (plus d’éléments)</option>
          </select>
        </div>
        <div>
          <label for="model">Modèle IA</label>
          <select id="model">
            <option value="simple">Gemini 1.5 Flash (rapide)</option>
            <option value="balanced" selected>Gemini 2.0 Flash (équilibré)</option>
            <option value="pro">Gemini 1.5 Pro (avancé)</option>
            <option value="max">Gemini 2.5 Pro (maximum)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <button id="runBtn" class="primary">Générer ma proposition</button>
        <span id="status" class="muted"></span>
      </div>

      <div id="result" class="result">
        <div class="badge-group">
          <span class="badge" id="detected"></span>
          <span class="badge" id="modelUsed"></span>
        </div>
        <section>
          <h2>Approche proposée</h2>
          <div id="approach"></div>
        </section>
        <section>
          <h2>Prochaines étapes</h2>
          <div id="next"></div>
        </section>
        <div class="row" style="margin-top:12px;">
          <button id="startMini" class="primary">Lancer un mini-diagnostic (10 questions)</button>
          <button id="downloadPdf">Télécharger en PDF</button>
        </div>
        <div id="diagnosticPanel" class="diagnostic hidden">
          <div class="diagnostic-header">
            <h3>Mini-diagnostic IA</h3>
            <p id="diagnosticIntro" class="muted">Répondez à ces questions pour obtenir un diagnostic rapide (10 questions).</p>
            <ul id="diagnosticExpectations" class="diagnostic-expectations hidden"></ul>
          </div>
          <div id="diagnosticStatus" class="muted"></div>
          <div id="diagnosticError" class="error" role="alert" aria-live="assertive"></div>
          <form id="diagnosticForm" class="diagnostic-form" novalidate></form>
          <div class="row diagnostic-actions">
            <button id="diagnosticSubmit" class="primary" type="submit" form="diagnosticForm">Analyser mes réponses</button>
            <button id="diagnosticCancel" type="button" class="secondary">Fermer</button>
            <button id="diagnosticRestart" type="button" class="secondary hidden">Recommencer</button>
          </div>
          <section id="diagnosticSummary" class="diagnostic-summary hidden" aria-live="polite"></section>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <div>POC — aucune donnée sensible, sortie indicative. Hébergé statiquement (GitHub Pages) + API proxy LLM côté serveur.</div>
  </footer>

  <script>
    const inferApiBase = () => {
      if (window.POC_API_BASE) {
        return String(window.POC_API_BASE).replace(/\/$/, "");
      }
      const meta = document.querySelector('meta[name="poc-api-base"]');
      if (meta?.content) {
        return meta.content.replace(/\/$/, "");
      }
      const { origin, protocol, hostname } = window.location;
      if (protocol === "file:") {
        return "";
      }
      if (["localhost", "127.0.0.1"].includes(hostname)) {
        return "http://localhost:8888/.netlify/functions";
      }
      return `${origin.replace(/\/$/, "")}/.netlify/functions`;
    };

    const API_BASE = inferApiBase();
    const runBtn = document.getElementById("runBtn");
    const needEl = document.getElementById("need");
    const themeEl = document.getElementById("theme");
    const toneEl = document.getElementById("tone");
    const modelEl = document.getElementById("model");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const approachEl = document.getElementById("approach");
    const nextEl = document.getElementById("next");
    const detectedEl = document.getElementById("detected");
    const modelUsedEl = document.getElementById("modelUsed");
    const startMiniBtn = document.getElementById("startMini");
    const diagnosticPanel = document.getElementById("diagnosticPanel");
    const diagnosticIntroEl = document.getElementById("diagnosticIntro");
    const diagnosticExpectationsEl = document.getElementById("diagnosticExpectations");
    const diagnosticStatusEl = document.getElementById("diagnosticStatus");
    const diagnosticErrorEl = document.getElementById("diagnosticError");
    const diagnosticForm = document.getElementById("diagnosticForm");
    const diagnosticSubmitBtn = document.getElementById("diagnosticSubmit");
    const diagnosticCancelBtn = document.getElementById("diagnosticCancel");
    const diagnosticRestartBtn = document.getElementById("diagnosticRestart");
    const diagnosticSummaryEl = document.getElementById("diagnosticSummary");
    modelUsedEl.style.display = "none";

    const DEFAULT_DIAGNOSTIC_INTRO = "Répondez aux questions pour obtenir un diagnostic rapide.";

    const friendlyError = (code, details = {}) => Object.assign(new Error(code), { code, ...details });

    const formatErrorMessage = (err) => {
      if (err?.code === "API_BASE_NOT_CONFIGURED") {
        return "API non configurée : remplace l'URL factice dans le code par celle de ton déploiement (ex. domaine Netlify).";
      }
      if (err?.code === "HTTP_ERROR") {
        const base = `Le serveur a répondu ${err.status ?? "avec une erreur"}.`;
        const body = err.body ? ` Détails : ${err.body.slice(0, 200)}${err.body.length > 200 ? "…" : ""}` : "";
        return `${base}${body}`;
      }
      if (err?.code === "BAD_JSON") {
        return "La réponse reçue n'est pas un JSON valide. Vérifie que l'API renvoie bien du JSON.";
      }
      if (err?.code === "NETWORK_ERROR") {
        return "Impossible de contacter l'API. Vérifie l'URL, la connexion réseau ou les autorisations CORS.";
      }
      if (err?.code === "VALIDATION_ERROR") {
        return err?.message || "Veuillez vérifier les informations saisies.";
      }
      return err?.message || "Une erreur inattendue est survenue.";
    };

    const ensureApiConfigured = () => {
      if (!API_BASE || /YOUR-NETLIFY|REPLACE|EXAMPLE/i.test(API_BASE)) {
        throw friendlyError("API_BASE_NOT_CONFIGURED");
      }
    };

    const postJson = async (endpoint, payload) => {
      try {
        ensureApiConfigured();
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const body = await res.text().catch(() => "");
          throw friendlyError("HTTP_ERROR", { status: `${res.status} ${res.statusText}`.trim(), body });
        }
        try {
          return await res.json();
        } catch (parseErr) {
          throw friendlyError("BAD_JSON");
        }
      } catch (err) {
        if (!err.code && err.name === "TypeError") {
          err.code = "NETWORK_ERROR";
        }
        throw err;
      }
    };

    const renderMarkdown = (text = "") => {
      if (!text) return "";
      const lines = String(text).split(/\r?\n/);
      const html = [];
      let inList = false;
      const closeList = () => {
        if (inList) {
          html.push("</ul>");
          inList = false;
        }
      };
      for (const line of lines) {
        if (/^\s*[-*]\s+/.test(line)) {
          if (!inList) {
            html.push("<ul>");
            inList = true;
          }
          html.push(`<li>${line.replace(/^\s*[-*]\s+/, "")}</li>`);
          continue;
        }
        closeList();
        if (/^###\s+/.test(line)) {
          html.push(`<h3>${line.replace(/^###\s+/, "")}</h3>`);
        } else if (/^##\s+/.test(line)) {
          html.push(`<h2>${line.replace(/^##\s+/, "")}</h2>`);
        } else if (/^#\s+/.test(line)) {
          html.push(`<h1>${line.replace(/^#\s+/, "")}</h1>`);
        } else if (line.trim() === "") {
          html.push("");
        } else {
          html.push(`<p>${line}</p>`);
        }
      }
      closeList();
      return html.join("");
    };

    const resetDiagnosticView = ({ keepPanel = false } = {}) => {
      diagnosticForm.reset?.();
      diagnosticForm.innerHTML = "";
      diagnosticStatusEl.textContent = "";
      diagnosticErrorEl.textContent = "";
      diagnosticSummaryEl.innerHTML = "";
      diagnosticSummaryEl.classList.add("hidden");
      diagnosticSubmitBtn.disabled = false;
      diagnosticSubmitBtn.textContent = "Analyser mes réponses";
      diagnosticRestartBtn.classList.add("hidden");
      diagnosticIntroEl.textContent = DEFAULT_DIAGNOSTIC_INTRO;
      diagnosticExpectationsEl.innerHTML = "";
      diagnosticExpectationsEl.classList.add("hidden");
      if (!keepPanel) {
        diagnosticPanel.classList.add("hidden");
      }
    };

    const updateDiagnosticExpectations = (items) => {
      if (!Array.isArray(items) || !items.length) {
        diagnosticExpectationsEl.innerHTML = "";
        diagnosticExpectationsEl.classList.add("hidden");
        return;
      }
      diagnosticExpectationsEl.classList.remove("hidden");
      diagnosticExpectationsEl.innerHTML = items
        .map((item) => {
          const title = item?.title ? `<strong>${item.title}</strong>` : "";
          const desc = item?.description ? ` — ${item.description}` : "";
          return `<li>${title}${desc}</li>`;
        })
        .join("");
    };

    const questionFieldName = (question, index) => {
      return `diag-${String(question?.id ?? index).replace(/[^a-z0-9_-]/gi, '-')}`;
    };

    const renderDiagnosticQuestions = (questions = []) => {
      diagnosticForm.innerHTML = "";
      if (!Array.isArray(questions) || !questions.length) {
        diagnosticStatusEl.textContent = "Impossible de préparer le mini-diagnostic pour le moment.";
        diagnosticSubmitBtn.disabled = true;
        return;
      }
      const fragment = document.createDocumentFragment();
      questions.forEach((question, index) => {
        const fieldset = document.createElement("fieldset");
        const legend = document.createElement("legend");
        legend.textContent = `${index + 1}. ${question?.title || "Question"}`;
        fieldset.appendChild(legend);
        if (question?.description) {
          const desc = document.createElement("p");
          desc.className = "question-description";
          desc.textContent = question.description;
          fieldset.appendChild(desc);
        }
        const optionsContainer = document.createElement("div");
        optionsContainer.className = "question-options";
        const fieldName = questionFieldName(question, index);
        if (Array.isArray(question?.options)) {
          question.options.forEach((option, optIndex) => {
            const optionId = `${fieldName}-${optIndex}`;
            const label = document.createElement("label");
            label.className = "option-pill";
            label.setAttribute("for", optionId);
            const input = document.createElement("input");
            input.type = "radio";
            input.name = fieldName;
            input.id = optionId;
            input.value = option?.value ?? String(optIndex);
            if (option?.label) {
              input.dataset.label = option.label;
            }
            label.appendChild(input);
            const span = document.createElement("span");
            span.textContent = option?.label || option?.value || `Option ${optIndex + 1}`;
            label.appendChild(span);
            if (option?.hint) {
              const hint = document.createElement("small");
              hint.className = "muted";
              hint.textContent = option.hint;
              label.appendChild(hint);
            }
            optionsContainer.appendChild(label);
          });
        }
        fieldset.appendChild(optionsContainer);
        if (question?.allowComment) {
          const comment = document.createElement("textarea");
          comment.name = `${fieldName}-comment`;
          comment.placeholder = question?.commentLabel || "Précisions (optionnel)";
          fieldset.appendChild(comment);
        }
        fragment.appendChild(fieldset);
      });
      diagnosticForm.appendChild(fragment);
      diagnosticSubmitBtn.disabled = false;
      diagnosticStatusEl.textContent = "Répondez à chaque question puis lancez l'analyse.";
    };

    const diagnosticState = {
      questions: [],
      systemInstruction: "",
      analysisInstruction: ""
    };

    let diagnosticLoading = false;

    const callDiagnostic = (payload) => postJson(`${API_BASE}/diagnostic`, payload);

    const beginDiagnosticFlow = async () => {
      if (diagnosticLoading) return;
      const need = needEl.value.trim();
      if (!need) {
        alert("Merci de décrire le besoin avant de lancer le mini-diagnostic.");
        return;
      }
      diagnosticLoading = true;
      diagnosticPanel.classList.remove("hidden");
      resetDiagnosticView({ keepPanel: true });
      diagnosticSubmitBtn.disabled = true;
      diagnosticStatusEl.innerHTML = '<span class="spinner"></span> Préparation du mini-diagnostic…';
      try {
        const data = await callDiagnostic({
          action: "generate",
          need,
          theme: themeEl.value,
          tone: toneEl.value,
          modelKey: modelEl.value
        });
        diagnosticState.questions = Array.isArray(data?.questions) ? data.questions : [];
        diagnosticState.systemInstruction = data?.systemInstruction || "";
        diagnosticState.analysisInstruction = data?.analysisInstruction || "";
        diagnosticIntroEl.textContent = data?.intro || DEFAULT_DIAGNOSTIC_INTRO;
        updateDiagnosticExpectations(data?.analysisExpectations);
        renderDiagnosticQuestions(diagnosticState.questions);
        diagnosticStatusEl.innerHTML = diagnosticState.questions.length
          ? "Répondez à chaque question puis lancez l'analyse."
          : "Aucune question n'a pu être générée.";
        diagnosticSubmitBtn.disabled = !diagnosticState.questions.length;
      } catch (err) {
        console.error(err);
        diagnosticStatusEl.textContent = "";
        diagnosticErrorEl.textContent = formatErrorMessage(err);
      } finally {
        diagnosticLoading = false;
      }
    };

    const collectDiagnosticAnswers = () => {
      if (!diagnosticState.questions.length) {
        throw friendlyError("VALIDATION_ERROR", { message: "Le mini-diagnostic n'est pas prêt." });
      }
      const answers = diagnosticState.questions.map((question, index) => {
        const name = questionFieldName(question, index);
        const selected = diagnosticForm.querySelector(`input[name="${name}"]:checked`);
        const commentEl = diagnosticForm.querySelector(`[name="${name}-comment"]`);
        return {
          id: question?.id || String(index),
          title: question.title || `Question ${index + 1}`,
          value: selected?.value || "",
          label: selected?.dataset?.label || selected?.value || "",
          comment: commentEl?.value?.trim() || ""
        };
      });
      const missing = answers.filter((answer) => !answer.value);
      if (missing.length) {
        const firstMissing = missing[0]?.title || "question";
        throw friendlyError("VALIDATION_ERROR", { message: `Merci de sélectionner une réponse pour « ${firstMissing} ».` });
      }
      return answers;
    };

    diagnosticForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      try {
        const answers = collectDiagnosticAnswers();
        diagnosticErrorEl.textContent = "";
        diagnosticSummaryEl.classList.add("hidden");
        diagnosticSummaryEl.innerHTML = "";
        diagnosticSubmitBtn.disabled = true;
        diagnosticSubmitBtn.innerHTML = '<span class="spinner"></span> Analyse en cours…';
        diagnosticStatusEl.innerHTML = '<span class="spinner"></span> Analyse des réponses…';
        const data = await callDiagnostic({
          action: "analyze",
          need: needEl.value.trim(),
          theme: themeEl.value,
          tone: toneEl.value,
          modelKey: modelEl.value,
          answers,
          questions: diagnosticState.questions,
          systemInstruction: diagnosticState.systemInstruction,
          analysisInstruction: diagnosticState.analysisInstruction
        });
        const html = data?.resultHtml || renderMarkdown(data?.result || data?.analysis || "");
        diagnosticSummaryEl.innerHTML = html || "<p>Aucune analyse n'a été renvoyée.</p>";
        diagnosticSummaryEl.classList.remove("hidden");
        diagnosticStatusEl.innerHTML = '<span class="ok">Analyse du mini-diagnostic disponible.</span>';
        diagnosticSubmitBtn.textContent = "Analyser de nouveau";
        diagnosticSubmitBtn.disabled = false;
        diagnosticRestartBtn.classList.remove("hidden");
      } catch (err) {
        console.error(err);
        diagnosticSubmitBtn.disabled = false;
        diagnosticSubmitBtn.textContent = "Analyser mes réponses";
        diagnosticStatusEl.textContent = "";
        diagnosticErrorEl.textContent = formatErrorMessage(err);
      }
    });

    diagnosticCancelBtn.addEventListener("click", () => {
      resetDiagnosticView();
    });

    diagnosticRestartBtn.addEventListener("click", () => {
      beginDiagnosticFlow();
    });

    startMiniBtn.addEventListener("click", () => {
      beginDiagnosticFlow();
    });

    runBtn.addEventListener("click", async () => {
      const need = needEl.value.trim();
      if (!need) { alert("Merci de décrire le besoin."); return; }

      runBtn.disabled = true;
      statusEl.innerHTML = '<span class="spinner"></span> Analyse en cours…';

      try {
        const data = await postJson(`${API_BASE}/analyze-need`, {
          need,
          theme: themeEl.value,
          tone: toneEl.value,
          modelKey: modelEl.value
        });

        detectedEl.textContent = data.detectedTheme ? `Cadre: ${data.detectedTheme}` : "Cadre: (auto)";
        modelUsedEl.textContent = data.modelUsed ? `Modèle: ${data.modelUsed}` : "";
        modelUsedEl.style.display = data.modelUsed ? "inline-block" : "none";
        approachEl.innerHTML = data.approachHtml || `<pre>${data.approach}</pre>`;
        nextEl.innerHTML = data.nextStepsHtml || `<pre>${data.nextSteps}</pre>`;

        resultEl.style.display = "block";
        statusEl.innerHTML = '<span class="ok">Proposition générée.</span>';
      } catch (err) {
        console.error(err);
        resultEl.style.display = "none";
        modelUsedEl.textContent = "";
        modelUsedEl.style.display = "none";
        statusEl.innerHTML = `<span class="error">${formatErrorMessage(err)}</span>`;
      } finally {
        runBtn.disabled = false;
      }
    });

    document.getElementById("downloadPdf").addEventListener("click", () => {
      window.print();
    });
  </script>
</body>
</html>

